<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Sas de Décompression Vigilant</title>
    <style>
        :root {
            --bg: #1a1a2e;
            --text: #e6e6e6;
            --accent: #e74c3c;
            --safe: #2ecc71;
        }
        body { 
            font-family: 'Segoe UI', sans-serif; 
            background: var(--bg); color: var(--text);
            margin: 0; height: 100vh; overflow: hidden;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        #timer { font-size: 8em; font-weight: bold; font-variant-numeric: tabular-nums; transition: color 0.3s; }
        .info { font-size: 1.2em; color: #888; margin-bottom: 20px; text-align: center; max-width: 80%; }
        
        #token {
            position: absolute; width: 60px; height: 60px;
            background: var(--safe); border-radius: 50%;
            display: none; cursor: pointer; border: 4px solid white;
            box-shadow: 0 0 20px var(--safe); z-index: 100;
            text-align: center; line-height: 60px; font-weight: bold; font-size: 1.5em;
        }

        .penalty-alert {
            position: fixed; top: 20px; background: var(--accent);
            padding: 15px 30px; border-radius: 10px; font-weight: bold;
            display: none; animation: shake 0.5s; z-index: 1000;
        }

        @keyframes shake {
            0% { transform: translateX(0); }
            25% { transform: translateX(10px); }
            50% { transform: translateX(-10px); }
            100% { transform: translateX(0); }
        }
    </style>
</head>
<body>

<div id="penaltyBox" class="penalty-alert">⚠️ PÉNALITÉ APPLIQUÉE (+5 MIN)</div>

<div class="info" id="status-text">
    RESTE CALME ET ATTENTIF.<br>
    Appuie sur les cercles pour valider ta présence.
</div>

<div id="timer">05:00</div>
<div id="token">?</div>

<script>
    // --- CONFIGURATION & SAUVEGARDE ---
    const STORAGE_KEY_TIME = "_sas_time_left";
    const STORAGE_KEY_EXIT = "_sas_exit_timestamp";
    
    let timeLeft = parseInt(localStorage.getItem(STORAGE_KEY_TIME)) || 300;
    let isFinished = false;

    const timerElement = document.getElementById('timer');
    const tokenElement = document.getElementById('token');
    const penaltyBox = document.getElementById('penaltyBox');

    // --- VÉRIFICATION DE L'ABANDON AU CHARGEMENT ---
    function checkAbandonment() {
        const lastExit = localStorage.getItem(STORAGE_KEY_EXIT);
        if (lastExit) {
            const timeDiff = (Date.now() - parseInt(lastExit)) / 1000; // en secondes
            if (timeDiff > 20 && timeLeft > 0) {
                applyPenalty("ABANDON DÉTECTÉ (>20s)");
            }
        }
    }

    checkAbandonment();
    updateDisplay();

    // --- CHRONO ---
    const countdown = setInterval(() => {
        if (timeLeft <= 0) {
            clearInterval(countdown);
            finish();
            return;
        }
        timeLeft--;
        localStorage.setItem(STORAGE_KEY_TIME, timeLeft);
        updateDisplay();
    }, 1000);

    // Sauvegarde l'heure de fermeture de la page
    window.addEventListener('beforeunload', () => {
        if (!isFinished) {
            localStorage.setItem(STORAGE_KEY_EXIT, Date.now());
        }
    });

    function updateDisplay() {
        let mins = Math.floor(timeLeft / 60);
        let secs = timeLeft % 60;
        timerElement.innerText = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }

    // --- LOGIQUE DES TOKENS (VIGILANCE) ---
    function spawnToken() {
        if (isFinished) return;

        let x = Math.random() * 70 + 15;
        let y = Math.random() * 70 + 15;
        
        tokenElement.style.left = x + "%";
        tokenElement.style.top = y + "%";
        tokenElement.style.display = "block";
        tokenElement.innerText = Math.floor(Math.random() * 9); 

        let caught = false;
        tokenElement.onclick = () => {
            caught = true;
            tokenElement.style.display = "none";
        };

        setTimeout(() => {
            if (!caught && !isFinished) {
                applyPenalty("ABSENCE DÉTECTÉE");
            }
            tokenElement.style.display = "none";
            if (!isFinished) {
                setTimeout(spawnToken, (Math.random() * 15 + 15) * 1000);
            }
        }, 4000); 
    }

    function applyPenalty(reason) {
        timeLeft += 300; // +5 minutes
        localStorage.setItem(STORAGE_KEY_TIME, timeLeft);
        penaltyBox.innerText = `⚠️ ${reason} : +5 MIN`;
        penaltyBox.style.display = "block";
        timerElement.style.color = "var(--accent)";
        
        setTimeout(() => { 
            penaltyBox.style.display = "none"; 
            timerElement.style.color = "var(--text)";
        }, 5000);
        updateDisplay();
    }

    function finish() {
        isFinished = true;
        localStorage.removeItem(STORAGE_KEY_TIME);
        localStorage.removeItem(STORAGE_KEY_EXIT);
        timerElement.innerText = "TERMINÉ";
        timerElement.style.color = "var(--safe)";
        document.getElementById('status-text').innerText = "Session de réflexion validée.";
        tokenElement.style.display = "none";
    }

    // Premier token après 10 secondes
    setTimeout(spawnToken, 10000);

</script>
</body>
</html>
